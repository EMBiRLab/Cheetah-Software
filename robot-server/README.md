# `RobotServer`

The `RobotServer` program exposes a command-and-query interface for a set of mjbots moteus motor drivers with real-time performance from a Raspberry Pi 3/4. The program is based around a demo program created by mjbots.

`RobotServer` is designed to have no notion of the robot, instead serving a bare-minimum, no-assumptions interface to a set of actuators. As such, it can work with an arbitrary number of actuators, as long as the interface LCM messages (`robot_server_command_lcmt` and `robot_server_response_lcmt`) are adjusted.

## `RobotServer` Quick Start

Example of common usage, running from the build directory:
```
sudo chrt 99 ./robot-server/robot_server \
--comment "insert your comment here" \
--path "/path/to/log/storage" --duration <seconds> \
--frequency-override <Hz> \
--skip-cal --skip-cfg-load --skip-zero \
```

- `chrt 99`: sets real-time priority to the highest level for the program
- `--comment`: allows the user to add a comment to the top of the output log
- `--path`: path to log write location -- ideally with fast write speeds
- `--frequency-override`: command and query frequency in Hz. Overrides value in `robot_server_config.json`
- `--skip-cal`: skips loading moteus calibration files (which are persistently stored on moteus boards). Omit to load changes in `/robot-server/moteus-cals`, which is rarely necessary
- `--skip-cfg-load`: skips loading moteus configuration files. Omit to load latest config changes in `/robot-server/moteus-configs`
- `--skip-zero`: skips re-zeroing actuator angles at startup location. Omit to re-do a "precision" re-zero.

See `./robot-server/robot_server -c "null" --help` for more info on command line arguments

## Hardware Dependencies

- Actuators are expected to use mjbots moteus motor drivers: https://mjbots.com/products/moteus-r4-8
- The CAN-FD interface should be provided by a mjbots pi3hat: https://mjbots.com/products/mjbots-pi3hat-r4-4b
The pi3hat is designed to work on Raspberry Pi 3/4 and uses its two SPI buses, though it's possible other platforms will work.

## Software Dependencies

- `cxxopts`: command-line argument parsing: https://github.com/jarro2783/cxxopts
- `nlohmann/json`: JSON file parsing: https://github.com/nlohmann/json
- `{fmt}`: output formatting: https://fmt.dev/latest/index.html
- `moteus_gui`: utility programs and scripts for interacting with moteus drivers: `pip3 install moteus_gui` (https://github.com/mjbots/moteus/blob/main/docs/getting_started.md)

## Robot Configuration

### `robot-server/moteus-cals/`
Moteus calibration files are stored in this directory. Calibration files represent fundamental properties of the motors in the actuators that should not change, except in rare circumstances. These files are auto-generated by mjbots calibration script, which can be executed with:

```
python3 -m moteus.moteus_tool --pi3hat-cfg="<BUS>=<ID>" --target <ID> --calibrate
```

This script will
1. calibrate the angle offsets between the magnetic encoder and the electrical rotation frame of the motor, and
2. run a motor-profiling procedure to calculate values for Field-Oriented Control (FOC), including motor properties and controller gains, then
3. write this information into persistent storage on the moteus driver boards and into an output file, which can be re-loaded at a later time

If the motor has a high resistance and/or is being calibrated with a frictional load (e.g., a transmission), it may be necessary to add the option `--cal-kv-voltage=2`, where 2 indicates a max line-to-line voltage of 2V (default: 0.8V) to be used during estimation of the back-EMF/torque constant. Increasing the voltage results in a better estimate. 

We also typically add the option `--cal-bw-hz=100` to ask the profiler to choose aggressive current controller gains.

Calibration is only necessary when first setting up an actuator, or if the motor rotor (and thereby its electrical rotation frame) slips relative to the encoder magnet, which may happen if torque transfer from the rotor to the rest of the system is not strong enough to handle high temperatures or torques. To check if this has happened, you can re-calibrate and compare the values in `"calibration":"offset"` within the calibration output file. If the offsets have appreciably changed, then a slip has occurred.

### `robot-server/moteus-configs/`
Moteus configuration files are stored in this directory. Config files represent mutable properties of the actuators that users may want to change on a frequent basis. These files are hand-written and loaded to the moteus controllers by either
1. running `robot_server` WITHOUT the `--skip-cfg` argument, which will reload configs for all actuators in the system, or
2. running `python3 -m moteus.moteus_tool --pi3hat-cfg="<BUS>=<ID>" --target <ID> --write-config <file>`, which will reload selectively.

The syntax of the config files is the same as the console commands described in https://github.com/mjbots/moteus/blob/main/docs/reference.md#b3-conf---configuration

A particularly important line in these files is `conf set motor.unwrapped_position_scale 0.13333333`, which sets the transmission ratio used in the actuators. In this example, the ratio is set to 1/7.5 for a 7.5:1 speed reducer transmission.

### `robot-server/robot_server_config.json`
This file stores information that defines critical behaviors for the `robot_server` program, including what actuators are connected and through which buses, where the program can find other files (actuator calibrations and configs), and actuator limits


## TODO

- Adapt command-line argument parsing to match MIT code
- Adapt JSON config files to YAML, to match MIT code
- Expand `robot_server_config.json` with more important parameters as features grow
- *Consider* implementing actuator-wise sign convention changes, angle offsets, and ordering here (these are currently the responsibility of the client on the other side of the LCM interface)
- Speed up program with 12 actuators connected. Current stable max on a pi 4 is ~700 Hz. Ideally it would be 1kHz. Investigate slow downs with data copying.
- Get `--help` output to show without a dummy comment